{% extends '_base.html' %}
{% load static %}
{% load humanize %} 
{% block navbar %}
{% include '_base_navbar_left.html' %}
{% endblock %}
{% block contents %}
<div class="content">
  {% block navbar-top %}{% include '_base_navbar_top.html' %}{% endblock %}
  <div class="row no-gutters">
    <div class="col-xl-4 order-xl-1 pl-xl-2">
      <div class="card mb-3">
        <div class="card-header bg-light btn-reveal-trigger d-flex justify-content-between align-items-center">
          <h5 class="mb-0">결제할 청구서 목록</h5><a class="btn btn-link btn-sm btn-reveal text-600"
            href="../e-commerce/shopping-cart.html"><span class="fas fa-pencil-alt"></span></a>
        </div>
        <div class="card-body">
          <table class="table table-borderless fs--1 mb-0">
            {% for item in invoices %}
            <tr class="border-bottom">
              <th class="pl-0 pt-0">{{ item.vendorName }}
                <div class="text-400 font-weight-normal fs--2">{{ item.chargeStartDate }} ~ {{ item.chargeEndDate }}
                </div>
              </th>
              <th class="pr-0 text-right pt-0">{{ item.rrpAmount | floatformat:"0"| intcomma }}원</th>
            </tr>
            {% endfor %}
            <tr class="border-bottom">
              <th class="pl-0">소계</th>
              <th class="pr-0 text-right">{{ subtotal.rrpAmount__sum | floatformat:"0"| intcomma }}원</th>
            </tr>
            <tr>
              <th class="pl-0 pb-0">합계</th>
              <th class="pr-0 text-right pb-0">{{ subtotal.rrpAmount__sum | floatformat:"0"| intcomma }}원</th>
            </tr>
          </table>
        </div>
        <div class="card-footer d-flex justify-content-between bg-100">
          <div class="font-weight-semi-bold">총 결제금액</div>
          <div class="font-weight-bold">{{ subtotal.rrpAmount__sum | floatformat:"0"| intcomma }}원</div>
        </div>
      </div>
    </div>
    <div class="col-xl-8 pr-xl-2">
      <div class="card">
        <div class="card-header bg-light">
          <h5 class="mb-0">결제 수단</h5>
        </div>
        <div class="card-body">
          <div class="custom-control custom-radio">
            <input class="custom-control-input radio-collapse" type="radio" name="payment-method" id="credit-card"
              checked="checked" />
            <label class="custom-control-label" for="credit-card"><span
                class="d-flex align-items-center mb-2 fs-1">신용카드/직불카드</span>
            </label>
          </div>
          <div>
            <form>
              {% csrf_token %}
              <div class="row g-2 mb-3">
                <div class="col-md">
                  <input type="name" value="{{ user.get_full_name }}" class="form-control" id="card_owner" required />
                  <label for="card_owner">카드 소유자 성명</label>
                </div>
                <div class="col-md">
                  <input type="tel" class="form-control" id="owner_proof" required />
                  <label for="owner_proof">생년월일(6자리) 또는 사업자번호(10자리)</label>
                </div>
              </div>
              <div class="row g-2 mb-3">
                <div class="col-md">
                  <input type="email" value="{{ user.email }}" class="form-control" id="owner_email" required />
                  <label for="owner_email">이메일</label>
                </div>
                <div class="col-md">
                  <input type="tel" class="form-control" id="phone_number" required />
                  <label for="phone_number">휴대전화</label>
                </div>
              </div>
              <div class="form-floating mb-3">
                <input type="tel" class="form-control" id="card_number" required maxlength="16" />
                <label for="card_number">카드번호</label>
              </div>
              <div class="row g-2 mb-3">
                <div class="col-md">
                  <div class="form-floating">
                    <input type="month" class="form-control" id="valid_until" required />
                    <label for="valid_until">카드 유효기간 (년/월) YYMM</label>
                  </div>
                </div>
                <div class="col-md">
                  <div class="form-floating">
                    <input type="password" class="form-control" id="card_password" maxlength="2" required />
                    <label for="card_password">카드 암호 앞 2자리 **</label>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="custom-control custom-radio">
            <input class="custom-control-input" type="radio" name="payment-method" id="paypal" disabled />
            <label class="custom-control-label" for="credit-card"><span class="d-flex align-items-center mb-2 fs-1">미리
                등록한 결제수단</span>
            </label>
          </div>
          <hr class="border-dashed my-5">
          <div class="row">
            <div
              class="col-md-5 col-xl-12 col-xxl-5 pl-lg-4 pl-xl-2 pl-xxl-5 text-center text-md-left text-xl-center text-xxl-left">
              <hr class="border-dashed d-block d-md-none d-xl-block d-xxl-none my-4">
              <div class="fs-2 font-weight-semi-bold">결제금액: <span class="text-primary">{{ subtotal.subTotalRrp__sum | floatformat:"0"| intcomma }}원</span></div>
              <button class="btn btn-success mt-3 px-5" type="submit" onclick="submitPayment()">청구서 일괄 결제</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" tabindex="-1" aria-labelledby="exampleModalLabel" id="paymentModal" data-backdrop="static"
    data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">결제</h5>
        </div>
        <div class="modal-body" id="payment-progress" style="text-align: center;">
          <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor"
            class="bi bi-credit-card-2-front" viewBox="0 0 16 16">
            <path
              d="M14 3a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h12zM2 2a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H2z" />
            <path
              d="M2 5.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5zm3 0a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5zm3 0a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5zm3 0a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5z" />
          </svg>
          <h3 class="mt-1">결제 진행 중...</h3>
        </div>
        <div class="modal-body" id="payment-error-container" hidden style="text-align: center;">
          <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" class="bi bi-exclamation-circle" viewBox="0 0 16 16">
            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
            <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/>
          </svg>
          <h3 class="mt-1">결제 오류</h3>
          <p id="payment-error"></p>
          <div class="modal-footer">
            <button type="button" onclick="resetPaymentDialog()" data-dismiss="modal" class="btn btn-primary">
              확인
            </button>
          </div>
        </div>
        <div class="modal-body" id="payment-success" hidden style="text-align: center;">
          <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" class="bi bi-check-circle"
            viewBox="0 0 16 16">
            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
            <path
              d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z" />
          </svg>
          <h3 class="mt-1">결제가 완료되었습니다.</h3>
          <div class="modal-footer">
            <button type="button" onclick="location.href={% url 'invoices' %}" data-dismiss="modal" class="btn btn-primary">
              확인
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    {% include '_base_footer.html' %}
  </footer>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/payment.js' %}"></script>
{% endblock %}