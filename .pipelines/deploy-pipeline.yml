


# Python to Linux Web App on Azure

# Build your Python project and deploy it to Azure as a Linux Web App.
# Change python version to one thats appropriate for your application.
# https://docs.microsoft.com/azure/devops/pipelines/languages/python

trigger:
- main
- develop

variables:
  containerRegistryServiceConnection: 'MateBilling ACR'
  containerRegistry: 'matebilling.azurecr.io'
  dockerfilePath: '**/Dockerfile'
  tag: '$(Build.BuildId)'
  # Agent VM image name
  vmImageName: 'ubuntu-20.04'
  # Project root folder. Point to the folder containing manage.py file.
  projectRoot: $(System.DefaultWorkingDirectory)
  azSubscription: 'Microsoft_Azure_Sponsorship_Gold_2021Q3'
  azWebAppName: 'matebilling'
  # Environment name
  ${{ if eq(variables['Build.SourceBranchName'], 'main') }}:
    environmentName: 'BillingPortal-Production'
    imageRepository: 'prod'
    webAppSlot: 'production'
  ${{ if eq(variables['Build.SourceBranchName'], 'develop') }}:
    environmentName: 'BillingPortal-Staging'
    imageRepository: 'dev'
    webAppSlot: 'staging'

stages:
- stage: BuildAndDeploy
  displayName: Build and Deploy stage
  jobs:
  - job: BuildAndDeployJob
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: Docker@2
      displayName: Build and push an image to container registry
      inputs:
        command: buildAndPush
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(containerRegistryServiceConnection)
        tags: $(tag)

    - task: AzureWebAppContainer@1 # Add this at the end of your file
      displayName: 'Deploy to Web App $(environmentName)'
      inputs:
        azureSubscription: $(azSubscription)
        appName: $(azWebAppName)
        imageName: $(containerRegistry)/$(imageRepository):$(tag)
        slotName: $(webAppSlot)
        deployToSlotOrASE: true

